<!DOCTYPE html>
<html>

<head>
  <title>Calendar</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Your custom CSS (for .nav-link underline, etc.) -->
  <link rel="stylesheet" href="{{ url_for('static', filename='CSS/style.css') }}">

  <style>
    .now-bar {
      position: absolute;
      height: 2px;
      background: red;
      left: 0;
      right: 0;
      z-index: 50;
      pointer-events: none;
    }
    .meal-block {
      position: absolute;
      background-color: #4f46e5; /* Indigo */
      color: white;
      font-size: 0.65rem;
      border-radius: 0.25rem;
      padding: 1px 4px;
      pointer-events: none;
    }
    .calendar-cell {
      position: relative;
    }
  </style>
</head>

<body class="bg-[#fff5da] flex flex-col min-h-screen">

   <!-- Header-->
<header class="w-full bg-[#FFF1CF] shadow-sm">
  <nav>

    <!-- MOBILE HEADER -->
    <div class="md:hidden flex px-4 py-3 justify-between items-center">
      <a href="{{ url_for('index') }}">
        <img src="{{ url_for('static', filename='images/PrepifyLogo2.svg') }}" 
             alt="Prepify Logo" class="h-12">
      </a>

      <details class="relative">
        <summary class="cursor-pointer text-gray-900 font-medium">Menu</summary>
        <ul class="absolute right-0 mt-2 bg-[#233723] text-white px-4 py-3 rounded-lg shadow-lg flex flex-col gap-3 z-50">
          <li><a href="{{ url_for('login') }}">Login</a></li>
          <li><a href="{{ url_for('signup') }}">Sign Up</a></li>
          <li><a href="{{ url_for('get_started') }}">Get Started</a></li>
          <li><a href="{{ url_for('shopping_list') }}">Shopping List</a></li>
          <li><a href="{{ url_for('calendar') }}">Calendar</a></li>
          <li><a href="{{ url_for('user_meals') }}">Your Meals</a></li>
        </ul>
      </details>
    </div>

    <!-- DESKTOP HEADER -->
    <div class="hidden md:flex px-8 py-4 items-center justify-between">

      <!-- LEFT SIDE: Logo + Nav -->
      <div class="flex items-center gap-10">
        <!-- Logo -->
        <a href="{{ url_for('index') }}">
          <img src="{{ url_for('static', filename='images/PrepifyLogo2.svg') }}"
               alt="Prepify Logo"
               class="h-12 cursor-pointer">
        </a>

        <!-- Navigation Links (LEFT SIDE NOW) -->
        <ul class="flex gap-8 text-lg font-medium text-gray-900">
          <li><a href="{{ url_for('get_started') }}" class="nav-link">Get Started</a></li>
          <li><a href="{{ url_for('shopping_list') }}" class="nav-link">Shopping List</a></li>
          <li><a href="{{ url_for('calendar') }}" class="nav-link">Calendar</a></li>
          <li><a href="{{ url_for('user_meals') }}" class="nav-link">Your Meals</a></li>
        </ul>
      </div>

      <!-- RIGHT SIDE: Auth Buttons -->
      <div class="flex space-x-3">
        <a href="{{ url_for('login') }}" 
           class="px-5 py-2 rounded-full border border-gray-800 text-gray-900 bg-white shadow-sm hover:bg-gray-200 transition font-medium">
          Login
        </a>

        <a href="{{ url_for('signup') }}" 
           class="px-5 py-2 rounded-full text-white bg-[#3F2EA8] hover:bg-[#2F2180] transition font-medium shadow">
          Sign Up
        </a>
      </div>

    </div>

  </nav>
</header>

  <!-- Main Content -->
  <section class="relative py-8 sm:p-8 bg-[#fff5da]">
    <div class="w-full max-w-7xl mx-auto px-4 lg:px-8 xl:px-14 bg-white rounded-xl shadow-md pt-14 pb-14">

      <!-- Header + Button -->
      <div class="flex items-center justify-between mb-6">
        <h5 class="text-xl leading-8 font-semibold text-gray-900">
          Weekly Calendar View
        </h5>

        <button id="open-modal"
          class="py-2.5 pr-7 pl-5 bg-[#238636] rounded-xl flex items-center gap-2 text-base font-semibold text-white transition-all duration-300 hover:bg-indigo-700">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none">
            <path d="M10 5V15M15 10H5" stroke="white" stroke-width="1.6" stroke-linecap="round"></path>
          </svg>
          Populate Week
        </button>
      </div>

      <!-- Week Header -->
      <div class="grid grid-cols-8 border-t border-gray-200 bg-stone-50 font-medium text-sm sticky top-0 z-10">
        <div class="p-3.5 text-gray-900">Time</div>
        <div id="day1" class="p-3.5"></div>
        <div id="day2" class="p-3.5"></div>
        <div id="day3" class="p-3.5"></div>
        <div id="day4" class="p-3.5"></div>
        <div id="day5" class="p-3.5"></div>
        <div id="day6" class="p-3.5"></div>
        <div id="day7" class="p-3.5"></div>
      </div>

      <!-- Calendar & Time Bar wrapper -->
      <div class="relative">
        <!-- Time Bar -->
        <div id="now-bar" class="now-bar"></div>

        <!-- WEEKLY GRID -->
        <div id="calendar-body"
          class="grid grid-cols-8 w-full border-l border-t border-gray-200 text-xs font-semibold text-gray-400">
        </div>
      </div>

    </div>
  </section>

  <!-- Time Selection Modal -->
  <div id="time-modal"
     class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-xl w-96 shadow-lg max-h-[90vh] overflow-y-auto">
      <h2 class="text-lg font-semibold mb-4">Set Meal Times & Assign Meals</h2>

      <table class="w-full text-sm">
        <thead>
          <tr>
            <th class="p-1">Day</th>
            <th class="p-1">Breakfast</th>
            <th class="p-1">Lunch</th>
            <th class="p-1">Dinner</th>
          </tr>
        </thead>
        <tbody>
          {% for day in ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'] %}
          <tr>
            <td class="p-1">{{ day }}</td>
            <td class="p-1">
              <input type="time" class="meal-time w-full border p-1 rounded" data-day="{{ loop.index0 }}" data-meal="breakfast">
              <select class="meal-name w-full border p-1 rounded" data-day="{{ loop.index0 }}" data-meal="breakfast">
                {% for m in meals if m.mealType=='breakfast' %}
                  <option value="{{ m.name }}">{{ m.name }}</option>
                {% endfor %}
              </select>
            </td>
            <td class="p-1">
              <input type="time" class="meal-time w-full border p-1 rounded" data-day="{{ loop.index0 }}" data-meal="lunch">
              <select class="meal-name w-full border p-1 rounded" data-day="{{ loop.index0 }}" data-meal="lunch">
                {% for m in meals if m.mealType=='lunch' %}
                  <option value="{{ m.name }}">{{ m.name }}</option>
                {% endfor %}
              </select>
            </td>
            <td class="p-1">
              <input type="time" class="meal-time w-full border p-1 rounded" data-day="{{ loop.index0 }}" data-meal="dinner">
              <select class="meal-name w-full border p-1 rounded" data-day="{{ loop.index0 }}" data-meal="dinner">
                {% for m in meals if m.mealType=='dinner' %}
                  <option value="{{ m.name }}">{{ m.name }}</option>
                {% endfor %}
              </select>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <div class="flex justify-end gap-3 mt-3">
        <button id="cancel-modal" class="px-4 py-2 rounded bg-gray-200">Cancel</button>
        <button id="save-times" class="px-4 py-2 rounded bg-indigo-600 text-white">Save</button>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="mt-auto bg-[#0E0E0E] text-gray-200 py-6 px-12 flex justify-between items-center">
    <!-- Left side: contact info -->
     <div class="flex flex-col space-y-1">
      <span>Contact Support</span>
      <span>(702) 555-1234</span>
      <span>support@prepify.com</span>
    </div>

    <!-- Right side: copyright -->
    <div class="text-center w-1/3">
      <p class="text-sm">&copy; 2025 Prepify. All rights reserved.</p>
    </div>
  </footer>

  <!-- SCRIPT -->
  <script>
    const calendarBody = document.getElementById("calendar-body");

    // Get dates for current week (Sunday–Saturday)
    function getWeekDates() {
      const today = new Date();
      const day = today.getDay();
      const sunday = new Date(today);
      sunday.setDate(today.getDate() - day);

      const days = [];
      for (let i = 0; i < 7; i++) {
        const d = new Date(sunday);
        d.setDate(sunday.getDate() + i);
        days.push({
          label: d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
          isToday:
            d.getDate() === today.getDate() &&
            d.getMonth() === today.getMonth() &&
            d.getFullYear() === today.getFullYear()
        });
      }
      return days;
    }

    // Fill header days + highlight today
    const weekDates = getWeekDates();
    for (let i = 1; i <= 7; i++) {
      const el = document.getElementById(`day${i}`);
      const obj = weekDates[i - 1];
      el.textContent = obj.label;
      if (obj.isToday) el.classList.add("text-indigo-600", "font-bold");
    }

    // Build 6:00–20:00 grid
    for (let h = 6; h < 21; h++) {
      const timeCell = document.createElement("div");
      timeCell.className = "h-20 p-2 flex items-end border-b border-r border-gray-200";
      timeCell.textContent = `${h.toString().padStart(2, '0')}:00`;
      calendarBody.appendChild(timeCell);

      for (let d = 0; d < 7; d++) {
        const cell = document.createElement("div");
        cell.className = "h-20 border-b border-r border-gray-200 calendar-cell";
        calendarBody.appendChild(cell);
      }
    }

    // CURRENT TIME BAR
    function updateTimeBar() {
      const bar = document.getElementById("now-bar");
      const now = new Date();
      const hour = now.getHours();
      const minute = now.getMinutes();

      if (hour < 6 || hour > 20) {
        bar.style.display = "none";
        return;
      }

      const rowHeight = 80;
      const rowIndex = hour - 6;
      const offset = rowIndex * rowHeight + (minute / 60) * rowHeight;
      bar.style.top = offset + "px";
      bar.style.display = "block";
    }

    updateTimeBar();
    setInterval(updateTimeBar, 60000);

    // ==== Modal Controls ====
    const modal = document.getElementById("time-modal");
    const openBtn = document.getElementById("open-modal");
    const cancelBtn = document.getElementById("cancel-modal");
    const saveBtn = document.getElementById("save-times");

    openBtn.addEventListener("click", () => modal.classList.remove("hidden"));
    cancelBtn.addEventListener("click", () => modal.classList.add("hidden"));

    function getCellPosition(timeStr) {
      if (!timeStr) return null;
      const [h, m] = timeStr.split(':').map(Number);
      if (h < 6 || h > 20) return null;
      return { rowIndex: h - 6, fraction: m / 60 };
    }

    function populateMeals(mealData) {
      document.querySelectorAll('.meal-block').forEach(el => el.remove());

      mealData.forEach(item => {
        const pos = getCellPosition(item.time);
        if (!pos) return;

        const cellIndex = item.day + 1 + pos.rowIndex * 8;
        const cell = calendarBody.children[cellIndex];

        const block = document.createElement('div');
        block.className = 'meal-block';
        block.style.top = (pos.fraction * 80) + 'px';
        block.textContent = item.name;

        cell.appendChild(block);
      });
    }

    saveBtn.addEventListener("click", () => {
      const mealTimes = [];
      document.querySelectorAll('.meal-time').forEach(input => {
        const day = Number(input.dataset.day);
        const meal = input.dataset.meal;
        const time = input.value;
        const nameSelect = document.querySelector(`.meal-name[data-day="${day}"][data-meal="${meal}"]`);
        const name = nameSelect ? nameSelect.value : '';
        if (time && name) mealTimes.push({ day, meal, time, name });
      });

      modal.classList.add("hidden");
      populateMeals(mealTimes);
    });
  </script>

</body>

</html>
